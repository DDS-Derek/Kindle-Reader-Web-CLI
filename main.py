import logging
import subprocess
import sys
import threading
import os
import time
import socket

import requests as res
from flask import Flask as fl
from flask import render_template as temp
from flask import request as req

# 配置
port = None


# 创建reader线程
def reader_thread():
    try:
        subprocess.check_output(['java', '-jar', 'reader-pro-2.7.3.jar', '>nul'])
    except:
        ...
    try:
        subprocess.check_output(['java', '-jar', 'reader-pro-2.7.3.jar'])
    except:
        logging.getLogger(__name__).critical('Unable to load thread:"reader",please check file or java integrity.')
        sys.exit()


# 创建flask线程
def flask_thread():
    app.run(host='0.0.0.0', debug=False, port=port)


def print_text():
    time.sleep(3)
    print("[INFO]")
    print("\tKindle-Reader-Web-Client Start!")
    print("\tGithub: https://github.com/Suto-Commune/Kindle-Reader-Web-CLI/")
    print("\tAuthor LolingNatsumi,hsn8086")
    if port:
        ip = socket.gethostbyname(socket.gethostname()) + str(port)
    else:
        ip = socket.gethostbyname(socket.gethostname()) + ":5000"
    print(f"\t * Kindle Web: http://{ip}\n\t * Reader Web: http://{socket.gethostbyname(socket.gethostname()) + ':8080'}")


# 线程创建
t_flask = threading.Thread(name='reader', target=flask_thread, daemon=True)
t_print = threading.Thread(name='reader', target=print_text, daemon=True)
t = threading.Thread(name='reader', target=reader_thread, daemon=True)


def thread_starter():
    t.start()
    t_print.start()
    t_flask.start()


# 获取bookurl
def get_book_url(url_path: str):
    url_path = req.full_path.replace(url_path, "")
    if "txt" and url_path[-1] == "?":
        url_path = url_path[0:len(url_path) - 1]
    return url_path


# 创建图片
if not os.path.exists("storage/assets/img"):
    os.system("mkdir storage\\assets\\img")
if not os.path.exists("storage/assets/img/noCover.jpeg"):
    img = b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01\x00\x00\xff\xdb\x00\x84\x00\t\x06\x07\x13\x12\x10\x15\x10\x13\x13\x16\x15\x15\x15\x18\x15\x15\x17\x18\x17\x15\x16\x12\x17\x16\x17\x17\x18\x16\x16\x15\x15\x16\x15\x18\x1d( \x18\x1a%\x1b\x15\x15!1"&)+...\x17\x1f383-7(-.+\x01\n\n\n\x0e\r\x0e\x1a\x10\x10\x1a-\x1d\x1d\x1d++---------+------+--------+--7-----------+---+---\xff\xc0\x00\x11\x08\x01\x03\x00\xc2\x03\x01"\x00\x02\x11\x01\x03\x11\x01\xff\xc4\x00\x1b\x00\x01\x00\x02\x03\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x05\x01\x03\x06\x02\x07\xff\xc4\x00?\x10\x00\x01\x03\x02\x04\x03\x06\x04\x04\x04\x03\t\x01\x00\x00\x00\x01\x00\x02\x11\x03!\x04\x121A\x05Qa\x06\x13"q\x81\x912\xa1\xb1\xc1BR\xd1\xf0\x14#b\xe1r\x92\xc2\x15$3Cc\x82\xb2\xd2\xf1\x07\xff\xc4\x00\x1a\x01\x01\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x06\x05\xff\xc4\x00\'\x11\x01\x01\x01\x00\x01\x03\x02\x04\x07\x00\x00\x00\x00\x00\x00\x00\x00\x01\x11\x02\x03\x12!1Q\x04\x13"2\x05#3Aa\xb1\xf0\xff\xda\x00\x0c\x03\x01\x00\x02\x11\x03\x11\x00?\x00\xfb\x8a" ""\x02" ""\x02" ""\x02" ""\x02" "(\xf51\x11U\xb4\xe2\xcek\xcc\xf5n[{;\xe4\x82B" ""\x02" ""\x02\xf2\xf7\x80$\x90\x073`\xbd.\x13\xb5=\xa6mZn\xc3\xb1\x8ei\xcd\x0f.\x00Y\xa6b\'\x98\n[\x8b#\xbbE\xc9vG\x1fU\xb4I\xc4\x10\xda!\xa3\xbbs\xc8i1\xa8\x13r#u\x9e\xcf\xf1<MlS\xa0\x97\xe1\xe5\xde\'06\x05\xf2\xe5 \\\xccZ\xf6M1\xd6""\xa8""\x02" ""\x02" ""\x02\x81\xc6\x18\xec\x9d\xe3\x04\xbe\x91\xce\xd1\xf9\xa0\x10\xe6z\xb4\x91\xea\xa7\xa2\rX\\Cj1\xb5\x1ae\xae\x00\x8f_\xba\xda\xb9N!\x888\x1a\xdd\xf3\\\x1d\x87\xa8\xe8\xa9H\\\xd3y\x99{GS\xa8\xb2\xd5\x8e\xedS\x8b\xc8\xa4[\x1f\x86\x06g\x11\xaeh\xfb \xeb\x9e\xf0\x04\x93\x0b\xcd\x1a\xa1\xc2F\x9e\xcb\x9f\xc1\xd2ur\x1dV\xb0\x80#+^\x01\x93\xfe\x18\x8f\xaa\xbe\x15X\xdbfh\x8e\xa1\x06\xe4Z?\x8c\xa7\xf9\x82 \xde\x88\x88<\xd5~V\x97\x1d\x00&\xd7\xd2\xeb\xe5\x98\xae$kb\x9d\\\xd3\xcf2Z\xcd\x80\x03\xc2\\\x07\xc5\x1a\x95\xf4\x8e-\xc4\x1bB\x91\xaa\xf0KA\x02\xc2M\xec\xbe}_\x89\x03\xde\x9c=6\xd0c\x83\xb38\x99s\xc6\xeci:L\xfc-X\xe4\xd4F\xab\x8a}L0\xcc\x0b\xbb\xa7\xda\xa1\xfc!\xe3\xe0\x1c\xe4\x89\xe9\n\xd6\xb7\x1e\xc6\x1e\xea\x9bZ(\xe7\x86\xb4\xe4\x8c\xda\x02|CI;\x04pq\xc2P\xa1J\x8b\xdfv\xd5\xa8r\x10\x1d7\x036\xf60\xac8}wc\xf1\x14\xaa\x96\xb5\x8d\xc3\x93\x99\xb2I$\x89\x11m%\xa2\xdbB\x8a\xe8x\x1d,Ci\x91\x88{^\xe9\xb1\x1f\x96\x05\x8d\x86\xf2\xacQ\x17F\x04D@DD\x04D@DD\x04DA\xe1\xf5\x00\xd4\xa8\x18\xec[\x8bH\xa4\t:H\xd0N\xf2m\x03\x9a\xb0sA\xd4(x\xdb\xb7\xbbh\xe9ki\xb2\x0f\x9e\xf1\\%G\xbc\x8c\xc0\x9b\xe6\xbc\x80\'S\xea\x9c#\x83F Q\xaf\xde0\xb9\xb9\xa9\x96\x10\'K\\I7\x88\xda\n\xefp\xdc!\xad\xa6Z~\'A.\xd4\x83\xb0\x1d\x05\xc7\xa9[\xb0\x98`\x0eb\x01p\x19se\x13\xd4\xe6\xd7a\xec\x82\x1e\x1b\xb3\xecg\xe3y\xf3\x8f\xb0S)p\xcam3\x13\xe6d{)\x92\xb2\x83\xc8h\xe4\x8b\xd2 ""\x0f\x15\xa95\xed-p\x0ei\xd4\x11 \xf9\x82\xa0q|\x1bN\x16\xad6\xb44dt\x00\x00\x00\x80H\x80:\xab%\x82\x10p|\x0e\xa1\xcbJ\xa5\\wv\xd6\x88m \xe8\xb3m\x0f\x1am\xb8*o\xff\x00\x9e\x0bW<\xdc\xdf\xf5~\xaa\xe2\x8ff\xb0\xcd\x0f\x1d\xd89\xe6\xe6\xe5\xb3\xb3y\x01\xb2vg\x83\x9c-70\x90\xe2\xe7\x93#\xf2\xd87\xd6\x07\xcdfJ\xba\xb8DE\xa4\x11\x11\x01\x11\x10\x11\x11\x01\x11\x10\x11\x11\x06\x08Z\xe9\xd1\x00\x97I\x93\xd6\xde\x81mX@EEW\x13V\xa5G\nO--\xb1a\x00\x18\x0634\x9b]Y\xd2\xa6`I\xa9>`\xfd\x02\x0f5\xe89\xce\xcf\xach\xdd=slR\x95R \xf8\xa3B\xd7j\'C;\x85\xbe\x93\xaf\x94\xf9\x83\xcf\x9c\xf5Y\xaa\xc0H\xf6\xfb\xfd\x94\x1bQaePDD\x05\xa6\xbe.\x9b>7\xb5\xbb\xf8\x9c\x05\xbdV\xe5\xccv\xf2\x85#@9\xee\x8a\x8d\'\xbb\xb4\x97~f\xc7-\x0c\xec\xa5#\xdd^\xd9\xe1\xc5L\x9e"\xd9\x8c\xe0\x0c\xbez\xc9\x1dWH\n\xe1{1K\x07N\x90\xafY\xed/$\x8f\x10\x90\xd2\xdd\x80\xe7\x04\x19\xea\xbbL&)\x95Z\x1fM\xc1\xcd;\x83*J\xb5\xb9\x11\x16\x90DD\x04D@DD\x04D@D^j:\x01 I\x00\x98\x1a\x9e\x88="\xaa\xc1q\x1a\x95d\xb6\x9bZ\x1a`\x878\xe6\x9eD\x01e5\x98\x83\xa3\xc6S\xee\xd3\xe4\xef\xd5\x04>\xeb&+6\xd5\x1aD\xff\x00P\x83\x1e\xa0,\xe2x\xed\x06\x10\xd3P\x12I\x16\xbd\xc4\xeayZ\'\x9a\xad\xe3\xb8\xac\xf5\r \xd8\xc8!\xcf$\x8c\xa0\xf8\x8eQ\xf0\xcePn\xe8U<7\x11\x95\xa3.rL\x16\x97x\xda\xf0\xc9\x8ap\x00sluh\x897P[\xe38\xd6v\xb7\xbb9d\xbb1\xb3\xa5\xad\x81\xe1\xf3\xcd\xad\xb4^\xb04\xbb\xd3\xfc\xc7\x822\x9b\n\xce/\x04@$\x91\r#\xa8T\xf8\x0e\x13U\xf2\xf3L\xb2\x93\x9d\x986At\x19\x19|`\xcc~Sk\xab\xfe\x1f\xc1)\xd3\xf8\xa5\xda\xc3L\x1c\xa0\x99"@\x13{\xf2TFu<01\xdf\xd5\xff\x001?e\x85|\x07\xfd1\xf2E\x06\xf4DTV\xf1~3K\x0e\x0ewC\xa2C`\x92|\x87\xf7\\\x0e?\x8b\xd4\xc4<\xb5\x8d\xbdO\x04\x9f\x13\xdc\x0e\x8c\x1b1\xbd\x1b\x1dI]\xe7h]\x87\x14I\xc4\x06\x96\xde\x01\xf8\x89\x8d\x19\x17\x9f%C\xd9\x1e\x11\x9761\xcc\xcb!\xc6\x93nr\xb6\xf7\xbd\xf4\xb0\xe9\xe6\xb1wZ\x8a\xce\xce\xf0Jo\xc4\xd4\xa1Y\xa5\xe5\x82\xe5\x8e!\xa0\xdaZH\x832b\xc7PWw\xc3\xf8}:\x0c\xc9I\xb9[3\x12L\x9ed\x92I\xd0{.{\xb0A\xa6\x9dZ\xa4\x8c\xefy\xcd{\x80.\'\xd4\x95\xd1\xe2\xf1\xd4\xe94\xbd\xefk@\xe6G\xb0\x1b\x95x\xcf\tR\x11SvW\x89w\xf4\\\xed\xc5J\x82\xfb\x02s\xb4{8\x0fEr\xb5\x10DD\x04D@DD\x04D@Z\xab\xd7k\x04\xb9\xc1\xbef\'\xcb\x9a\xd5\xc4\xb1\x0e\xa7M\xcfk\x0b\xc8\xbePb\xdb\xec\xa9\xb8\x1e.\x9b\x9c\xea\xd5^\xde\xf1\xc6\x00u\x83\x1a4\r&\xde\xdc\x90XT\xa7\x9d\xfd\xe50\xe6?\xf3\x16\x90\xd7\x0eO\x06\xe4u[\xaaUwvC\xf2\xd26\x19\x8c9\xbe\x93\xf4+w\xf1t\xff\x00;}\x08?E\x0b\x8e\xe1\x8dj\x044K\x81\x0e\x00\x88\xcd\x1a\x8fQ*\n\x9c_\n\x15\xaae{\xf3\x86\x9b\x93\x94\x06\xb4]\xb3\x02\xe6\xfaz\xe9\x01\\\xe1\x9fF\x93rR\x83\x94\x01\xe1\xf1t\x12\xe5\x03\x0bF\x89\xf8p\xaf\xcd\xb8sKZ\x0f\x9b\x8c|\x95\x8d\x1aD\x078\xc7\x87F\xb4CZcnf\xfa\xa0\xa9\xed\x05J\xc4\xb4\x89kD\x19\x90\x01y$\x06\xeb%\xd6\xd3\xaa\x9d\xd9\xbcoyJ\x0b\x8b\x9e\xd9\xccI\x92d\xc8?oE;\x19\x83mFdw+\x18\x12\xd3\x11\x98N\x86\xeb\x96e#\x83\xc4Cs\xb9\xa0\ts\x84\x07\x03\x12\x01\xdd\x07b\xb2\xbc\xb5\xd2$hn\x8a\x8fH\x88\x82&?\x87S\xad\x97\xbcn`\xc3\x98\x0b\xc4\xe9~c\xa2\x95\x1b,\xa8\xf5\xf1\xd4\x98\xe0\xc7\xd4k\\\xef\x84\x17\x00O\x94\xa0\xa2\xc7\xf6:\x8b\xde^\xc7:\x917!\xb0[\'\xa1\xd1Goa\xa9\xcc\xba\xb5C\xe8\xd1\xf5\x95\xd6\xacf\x13\x1b\xa9\xdb\x17j\x17\x08\xe1T\xf0\xcc,\xa6\x0c\x13$\x93$\x98\x03\xec\xa7"*\x82" ""\x02" ""\x02\x87\x8c\xc3\xd1\x033\xd8\xcfP$\x9d\x84\xa9\x8a7\x10i,9[\x99\xc2\xe3I\x9ebA\x12\x82;jR\xa4c\xc2\xd3\xc9\xad\xd3\xfcD\x05\xe7\x0b\x8emRIxh\x9b6@$s;\xadx*\x8fw\xf2\xc52\xc0 \xb9\xcf\xb9$\xde\xc0\x8b\xb8\xf3\xd9m\xc4`\xcb%\xf4\x9c\x1awi\x12\xd2zr>J\tU+\x86\x89\x1e\x9dO!\xcd\x1c\xdc\xb4\xe3\xca|\xc9\xba\x8f\x83\xa0\xe2\xe2\xea\x8e\x0e-\xb4\r\x01\xd7\xee\x14\x8ck\xbc nH\x03\xdeO\xc8 \x90\xabx\xfe\x14T\xa0y\xb7\xc4=5\xf9+%\xe6\xa3d\x11\xcc\x10\xa8\xe5)c\x1e\x1a\x1a\r\x80\x00z"\xd7\xa5\xb9Y\x14\x1d\x8a"*5\xd7\xac\xd64\xbd\xc6\x1a\xd1$\x9d\x00\x1a\x92\xb8~\xdb\xf1j\x15\x98\xc6Sp{\x9a\xe9$\x0b\x01\x04Fm\xef\x1ar]\x97\x10\xc6\xd2\xa4\xd2j\xbd\xadi\x06\xce\xdcn#R\xbee\xc4\x85\x07\xd7\x03\x0c\x1d\x95\xc4\x0f\x19\x86\xc90#p\xdf2\xb3\xca\xb5\x1d\xc7d8\xb1\xafD4\xb1\xc0\xd3k[\x98\xdc>\x04L\xf3\xb5\xfc\xd4~\xd63%l5f\x9c\xaf5\x052A\x89i\xbc\x1e{\xfb\xa8\xc3\x89\xe3hT\xee\x9dE\x95%\xa0\xb5\x94\x81\x01\x82`^4\xb6\x8a\x1f\x16\xc1\xe2\xab\xbe\x83q%\xac\x15\x1f\x95\xadh\x9c\x96\x92OX\xeaT\xdf\x03\xbb\x0b*\x9f\x80\xf0!\x85\xcd\x15\x1c\xfc\xd1c\x00\x08\xde\x06\xea\xe1m\x91\x11\x10\x11\x11\x01\x11\x10\x11\x16\x10ea\x16\x10U\xd3\xe21R\xa50\xd2\xf7f\xd8\x88\x88\x02\xe7e!\xb9\xdc\xf1\x9a\x04\\4\x19\xbf7\x1e\x9b\x05\xea\x8e\x17 \x86\xb8\x00d\x98h\xccf\xfa\xa9\x0c`\x02\x07\xef\xcdA\xa0\xb81\xce\xd4\x97A\x88\xdfI\x9d9,\xd2\xa6K\xb3\xbf\xd0r\xeb\xe6\xa4"\x0c\xac\xaf+*\x8e?\x11Y\xd9\xdc\x03\t\xb9\xe5\xcd\x14\x87\\\x92\x8b#\xa9Z\xb14\xcb\x98\xe6\x83\x05\xcdp\x04\x18 \x91\x12\x08\xd1mE\xa1\xcb\x1e\x01O\x0fM\xd5\xea5\xf8\xaa\xa0M\xe5\xd2z6\xf6\xf3\x95\xccv\x82\xbdj\x8f\xa4j\x16Ih,e?\xf9`\x91\r#c\xa2\xfaG\x10\x15;\xa7\xf7Q\xdee9\'\xf3E\xb5\\W\x0f\xec\x9dz\xd5\r\\C\xbb\xb92b\x0b\xdcy\xda\xc1b\xcff\xa5Xbjb\xdb\x96\x9b*7\xbc\x14\x9a\x1cH\x0es\xea4\x17\xf7`\x9b\x03\x0f\xf5\x85\xbb\x1bZ\xa1n\n\xa5f\xe5\xa9\xdf\x0c\xc3\xcc\x11\xe9e+\x0f\xd9z,c\xd8\xd7?\xc7\x94\xe6.\x04\xb5\xcd$\xb5\xed \x082W=\xc6\xb1\x18\xb6>\x95\x1a\xf0\xe6\xb6\xa3\x1c\xca\x80]\xf0b\t\xd2o\xa4J_\x03\xbeDE\xb6DD@DD\x04XX\x94\x19XIXP\n"\xc2\x0c\xac\xaf\x05\x14\x1e\x96W\x85\xe94ex\xac\xe8i<\x81\xfa/j7\x12$Rtk\x10\'I)\xa2\x88So_u\x95\xb2\x96\x15\xe5\xa0\x90$\x80M\xca)\xa3\xa3DE\xb0D\\\xff\x00i;B\xfc+\x83{\x9c\xc1\xc2Z\xe2\xe8l\xee\x08\x8dt\xdft\xb7\x07@\xbcT\xa4\x1dg\x00`\x82$M\xc6\x85|\xfd\x9d\xab\xc6U\xa8\x1bI\xad\x9f\xca\xd6f\x9f=\xe3\xd9w\\>\xa3\xddI\x8e\xa8\xdc\x8f#\xc4\xdd`\xa9.\xae$\xa2"\xa8""\x02\xc1E\x82P\x16\n,\x15\x02Qy\xca\xb3(\x12\xb2\x8b\x0ep\x02I\x81\xd6\xca\x01;\xadN\xc50\x00s6\xf6\x10A\x93\xac\x0ej\xb3\x89\x13P8gsi\xe9b\x00x\xb4\xde&5\x1a\xae;\xb5\x9c2\xa5G6\xbd\x08\x15iAl\x18&6\xfe\xaf\xad\xf7X\xe5\xcf\x1a\x9c_Dv \x03\x1b\xed\xfa-\x9d\xe2\xf9\xa3\xfbR\xea\x8d\xa3Q\x80\xb5\xd9\x8b*\xb0\xfcT\xdc\x05\xe2v\xd5_v\x7f\x8b>\xa0\xcfS\xc2\t\xb4\x9b\xbb\xa7\xef\xc9bu|\xe3]\xae\xb1\xcf\xe5\xaf.\x7f\xddE\xe25\x81\xa7\xea\x07\xd4\xfd\x91\xa5\xc7oU\x17\x8d\x02\x03]\x1f\xe2\xff\x00\xd9u\xd6,ZQ\xa6\x03@\xe8>\x88\xb41\xc4\x80s\x9b\x89\xd0,\xa0\x9a\x88\x8bh\xf2\xf7\x80$\x90\x00\xdc\x98\x0b\x97\xedw\x1a\xa0h:\x90\x8a\x8eu\x85\xac\xd3\xf9\xf3i#\xa2\xb1\xed\x06$\xd3v\x1c\xc4\xb4\xd6\r=Ik\x83\'\xa6b\x0f\xa2\xa1\xed\x87\n\xa9\r\xac\xfa\xdd\xe1.k\x1a\xd2\xd0\xc676\xb1},?U\x9bV4\xf6\x7f\xb4Tp\xccm\'S\xbd\xf3TfS2I\x00\xc7\xc5\xcbU\xd0S\xedM\x02FaR\x98:9\xec-o\xba\xe0\xc0{\xfb\xaae\x8d\rs\xe1\xa5\xad\x00\x93!\xae\xbe\xae\x02w]\xc7n\x1c\x06\t\xc0\xee\xea`y\xe6\x07\xe8\n\x92\xdcZ\xe8\x18\xe0D\x83 \xdc\x11yYT\xbd\x8f\xa6\xe6\xe0\xe9\xe632G@I\x81\xec\xaeV\xe3,\xac"\xf2J\x0c\x95\xe4\x94%x*\x0c\x97$\xaf\x10\xb2\xe2\x832\xbd\x05\xe6y|\xd7\x965\xd3$\x88\xe5\xa4(6*\xce=\x9d\xcc\x14\xa9\xfcO \xcd\x8c\x06\x90\xef\x84\xeam\xa2\xdc\xca\xb1\x12\xe2\x01\x98:\xc1\x1b\x19^kRs\x88ppv[\x8d\x94\xaa\x87V\x89\x14\xb2\x92d\x0b\x97\x82$\xf9\xe9\xec\xab\xb0<\x1cD\x91\x19\xa4\x88{\xfd\xeeU\xae8\x87\x169\xe0\xb4\xb6l\xe9,$\xe8\\\x06\xb0V\xfc>\x1d\xc6\xf5\x1c\xd3\xbc\xb4\x9d9\x0eAs\xbce\xadK\x8f\x9c\xd6\xec]gb\x1c\xf6\xd79\\M\xcb\x0f\xb1\x83\xecWK\xc1\xfb6\xdaN\x0e5\x1f\x98\x08\x87\x10\xe8\xf2\x16\xd5t\xd4\xe9\x839I\x8d9\xfdvPq\x83\xb9\xaa*\xf8\x8b\\!\xfb\xc1\xb4\x13\x1d.6\x10\xeej|\xb8\xba\xb0\xa4`nO\x94*j\xd5\x9c\xfciip\xca\xd0\x00hp\xde\t$\r5\xd3\xa2\xb8}a\xa2\xa5#\xfd\xf0\xff\x00+-\x81\xcf\xf9\xf4\xbd\xb7\xdb\x9d\x97Mg\x16\xbf\xc07g<\r\x80t\x009\x01\xc9\x17\x9f\xf6\x8d?\xcc>h\x9ab\xd9\x11\x17FT}\xb1\xa2]\x85/n\xb4\x9c\xda\x9f\xe57\xf9\x12\xab{K\xc5p\xd5i\xd2\x06\xabL>\x9b\xdc\xd1$\xe5\xfcB\xda\x18+\xac{A\x04\x11 \xd8\x8ea@\xc0\xf0j\x14~\nM\x07Y#1\xf4\'@\xb3b\xbey\x82\xc4Q\xa7\x8bmA\x9c\xd1c\x8b\x87\xe21|\xa6 @\xf8}\x95\xe7l\xf1\xe3\x10hP\xa2\xe0\xec\xf0\xeb\x7fU\x98\x0f\xb9+\xb14\x19\x98\xbb(\x97\x00\xd2`\\\t\xb1\xe9r\xa9x_f)\xd0\xc4:\xb82/\xdd\xb6>\t\xd6\xfb\xeb\x03\xa2\x99WWxj!\x8ck\x06\x8dhh\xf2\x02\x16\xd5\xe72\xc1+L\xb2J\xf3+\x0e+\x01\xc80J\xc1+\x04\xac\x054zj\xc9\x0b\x12\x99\x91q\xe5\xc27\x85\xa9\x95\x1eD\xd8\x0e\xa2\xe7\xac-\xaexZ*\xd43\x03\xff\x00\x8ah\xd0C\xb2\x9b\xc8\xd6\x08\xb4\xada\xb2;\xc6C#X\'\xff\x00\x15)\xf4\x81\xdc\xfaYj\xaf\x85ha1~k*\x8e\xea\xce\xa8\x1c\x1c\xeb\r\xb9\xad8J\xa5\xb67\x1c\xaf\xee\x14\xccKC[\x9e/\x00\x0f=\x93\x07\x86-\xbb\xaeN\xbfe3\xca\xe9\xdf\x08\xf0\xbc\x88\xd8\xff\x00u\xe1\xf5K\xdb\x0e"\x0f@t\xe8\xa6T`v\xa2\xcbF&\x9bZ\x0b\x80\x8c\xa2LjO\xe1o\xa9K*\xcb\x118MRi\x878A\x16"I\xcb\xd34\\\xc1\x17Qx\xfe8\xb5\xcd\x00\x80H\xf9]J\xe1\x99\xc3\x03]\x079\xce\x08\xb4\x88h\xdf\x9eR}B\xa1\xed]B\xda\xa2A\xb3dz\x92\x92%\xa8\xfd\xf8\xea\x8a\x9cb\x1d\xc8\xfb\xa2\xd63\xaf\xb0\xac"\xc1]\x10%a\x16%@E\x89X\x84\x19X\x05!f\x10y+\xcb\x8a;U\xe4\x95\x15\x80\xb5b*=\xa4\x1036.\x07\xc7\xe6\xd9\xb1\xf2[\xd6!f\xfa\x0cQ\xac\xd7\xb49\xa6A\xf4\xf4#c\xd1x\xc4Wku?u\xe9\xed0K"LL\xe8|\xfa\xc2\x06\x00$\xeb\xd2]\xf6S\xce\r\r|\x89\x82\'\x98\x83\xea\xbd\xe4Yc\x84\xc7\xd4\x11\xf2+`\x12`"\xbc1\x86`,Tr\x9a\xc6B\x8fY\xbe"\xaexDW\xb4\x12\t\xdbO>k^+\x14\xdam\xccM\x86\xbe|\x94\xbc\x8a\xaf\x8cp\xae\xf9\x85\xb2A\xe4\r\x8f\x9f\xf6EX\xb0\xccy\t\xe7u\x1f\x8cU\x0c\xa0\xf7\x1d\x81:I\xb0$@\xdc\xd9rt\xf8\xe6#\x0c\xfe\xee\xa3\x01\x00\xe8Ai1ik\xb7\xb7\x9a\xbf\xaf\xc4{\xfc;*\xd2\x12\xc7>\x1f\')cC]\x9b\xcc\x82\x1a#\xaaR-\xbb\x91\xe1#\xf0\x80\x07\x94(\xb8\xcc3MjosA" \xf2\xba\x9f?\xaa\x8bZ\xb3MV\xb70.\x11"n4\x89\x1e\xa8$\x1c\x153r\xc6\xc9\xfe\x96\xfe\x88\xb7"\xa3r\xc2\xca\xc2\xd3,\x15\xe4\xac\x95_\x8f\xe2\xf4h\x98\xa8\xf0\xcbM\xc1\xb8\x98\xb4j\x82pY\x05D\xe1\xbcB\x9dv\x17\xd39\x9a\tl\xc4\\k\x1e\xeaK\xad\x7f\x92\x04/K[jJ\xcb\x9c\x83\x0e\x0b\xc9Y\x95\x82T\x06\xb9 \x1b\x95\xaf0\x02v^*\xd6\x8d>\x8b5R\xda\xbd\xb0*\xf6\xe3\x05\xe6\xc4\\\xeb\x11\xceHR\xf0\xf5$y\x1f\xee>\xaaK\xa67\x10\xbc\xd3\x10=\xd6\x1e\xf8\x0bM*\xe3\x9f\x92\xcf.\xaf\x0e6KZ\x9cmJZ1.\x00\x89;G\x9f\x972\xb6\x07\x88F4Nm\xfe\xcb\xa4\xb2\xb3\x8dmi:\x08\x1du>\x9c\x97\x877\x98[1\x15\x88\x86\xb4\x02\xe3:\xd8\x005q\xe9u\xe5\x94\x89\xbb\x9d\xb6\xc0\x0e\xb3}\x15\xc1\xa8\xd2\x04\xc9\x00\xda.&\xde\xaa\x17\x11\xaaZ\xc0\x1b\x95\x870\r\'\xc2\xc2Ht\x03\x17\x17V4\x9d\xab\xb6\xb7\x9c~\xe1G\xe2r[\xe1\x82\x03\x81p7\x96\xc1\xcc\x04jy)g\x85\x89Z\xaa\x9c[\x0b1\x01\xf1L1\xc0\x0c\xda<\xb8\x11bw\xe9\xe4\xb6\xd7\xc0\xbd\xbe*\x0e\xcb\xbfv~\x03\xe5\xbb|\xb4\\\xf7\x11\xe3\xe1\xee\x02\xa3CM#\'\xc5p\xeeq\xb5\xbe\xaa[\x83\xb3\xcc:"\xa6\xa5\xc4\xda\xe6\x87K\xae\x01\xd0\xee\x8b=\xcb\xda\xbfX++[\xdd\x0b\xab\x0c:\xd7\\O\x11\xc2V\xe2\x15Io\x86\x8bIc\\D\xe6 \xc3\x9d\x1c\xa7\xde\x17o\xaa\xae\xe1\xf4\x9fH\xf7!\xa3\xbbl\x96\xband\x92G\xa4\xa0\xdb\xc20m\xa1A\x94\x9a"\x05\xf9\x97~"z\x92\xa5U\xaa\x00\x9eQoU\xe9j\xaa\xc9\x111\xd5A\xad\xb5\x83\xeaxH-\r\xb9\x07y\xb0\xfd\xf2[\xc3UY\xc5\xb5\x95!\xae\xf04\x00\xe1"g\x98\xdc\xc6\xfeeY>\xa0\x80g]\x12U\xb1\xae\xadO%Z\xfe!\x94\xc3\x8c\x13\xa1\xd9L\xc6\xbe\x1bo\xd1R\xd7\xa2j\xb4\xcc\x11\xcbx\xe8\xe3\xa2\x9c\xa9\x15\xbcW\x8e8K\x06\xb9\xa3\xa7\xefem\xd9\xde>\xc7\x82\xc2\xf9\xc9\x00\xbeDN\xf6\xd2:\xae/\r\xd9\xba\xd5\xea\x91Q\xde\x11p\xdb\x8c\xdc\x80x\xfd\x17[\xc1x5*\x16\xa7Hrq\xb9#\x98\x899\x96f\x8e\xa5\xcf#Q#\x98\xbf\xbb\x7fI^e\xbf\x13`\xed#p\xb4\xd2k\xc4\x06\x90\x1b\xfdM&:\x0b\x88\x080\xce.q0\xd2E\x8bt\xff\x00\xb9\xbc\xe5^{\x9fO\xa9=Q1\xb8\xb8\xf8\xb4\x8d\xa4\xdeb\x0cz.{\x11\xc5$\xc3C\xa4s\x10-m\xef\xa9\x1b.\xcc\xe1\x18\xe6\xe5,\x11\x11\xa7\xdf\xee\xa8\xf8\x87\x08\x03\xfd&:\xc9\x0e\xf6\xf9/\x9c\xfcO\xe0\xfa\xf3\xf37\xba\x7fO\x7f\xc2\xf5z{\x9c\xa3g\x05\xc4\xbc\xb0\x17n\\|\x801\xae\xf7W\x8d"\x156\x07\x0cH\x81c\xbf!\xe4\x15\xbbZ\x18\xdf\xbe\xe4\xafw\xe1W\xa9\xf2\xfe\xaf\xb7\xde\xb8|Gow\x80\xd3\x9fX\x9f!\xb2\xf4\xeaS\xa9\xfa/,\xab\xfb\xe5\xd1d\xd7\x13\x1b\xaf\xd7\x96c\xcc\xd3W\x07;\xeb\x13\x16\x98\xd2Tn"\xec\x94\xe2@t\x80\xdc\xc6$\x99\xca=z+\x07<\xfc\xd6\x8cK\x01"D\xf9\xecv?U.,j\x0fsIni\xbc\x89\x03C\xb7X2\x17%\xda\x1e\x1a\r\\\xc1\x84\xba\x0b\x89\x90\x03\xaf\xb3F\xe2~k\xb6{\x03\xac@>bU\x07\x1a\xe1mk\xc5a\x98\x18- \x13\xe8gY\xd9f\xc5\x95\xcbfp\xb6R=\xd1u\xb4\xf04\x88\x06]p\x0e\xa4"\xc2\xba\x05\xe4\x85\xe9awa\xa1\xef\x00\x81\xeb\xbe\xddV\xaa\x8d\x7f\xc6\xc7\x03\xfd$H\xf7\x1a(\xbck\x1c\xda`I\x83\x9869\xcf\xc2G;\xc2\xdfK\n\xc3%\x96\xbc\xda\xd2c\xe4\xa0\x86\xce#P\xbe\x03\t\xe91\xa6\xc0\x91\x12\xb1\x8a\xafQ\xc5\xec\xcai\x97\xb3+\'\x9c\x19\xb8\xe7? \xb76\x96Y5\x88\x05\xc6\xc4\x12"\xdaO\xa6\xb6U\xb8\xce%\xdf\xd5\xa7J\x98\x90\x1e\tw8\xd8tX\xe5\x7f\x97n\x97\x0e\xed\xf1\xe3\xdd\x0b\xb3|z\x9b@\xa3]\xac\xa6\xe6\x82\xdc\xc4Fo^\xb7W\xd5)d\xc8\xe6\xff\x00\xc3tH\x82r\x92,\xebh G\xb7\xad_\x11\xec\xebqM{\xc3\xc09\x8d\x9a!\xa4\xfeW\x12>\x8a\xf3\x83a\xddO\x0fN\x95B\x0b\x9a\xd0\xd3\xb81\xe7\xad\xa1jG\x19L^\x80s\xde,\x072\xa32\x1f!\x86\xd7l\xc6\xdb\x9f5-\xcd\xc9y%\xa6,v\xda\xde\xeba6\x9fdT\x1f\xe1\x1e\xd0b\x1d\xea\x1b\xe5\xb7\xddY\xd0\xac\xd2-\xe1#PlGB\x16\xb1R\xca\xbb\x89\xe6y\x14\xd9\xa8\xb9;\x8f^\x80\xcf\xb2n\x0b\x87Vo?\xbf\xd1C\xad\xc4\x9bN\xee\x90\xdd$\xb5\xc2<\xe4i\xf4T5\xb0\xce\xa5R\x93\x9b\x9c\xb6Kj\x1c\xe4\x00\xdc\xae\xbcO2\r\xaf\xe1V8|\x05g\xfcU\x1e\xd6\xe6\x9b<\xc9l|<\xc5\xf7X\x9c\xfb\xbd"\xe6.\xd8\xe0D\x82\x08;\x8b\xacV\xa2\x1c\xd2\xd3\xa1\xfd\xca\x89K\x00\xc6N@ZM\xc9\x04\xdc\xf33\xa9Q*Us*\x8e\xf2\xab\x857xE\xda\xd0\xd7l\t\x00\x1b\xf9\xea:\xad\xdc\xb3*%`\x9c[, \xe6\x06\xe4\xc4\x1eQ\xbe\x9fu#\xb8\x9b\xb8\xc9\xdb`<\x87\xddle0\x17\xad\x14\xe1\xc2q\x9d\xbf\xb4-\xdb\xa8E\x85\x92&y[\xf7u\x8a\x01\xb3s\x7f\x9a\xd5\x8fxs\xdaX\xfb\xdc\x10\x08\x8fU\xa9\xf4\xc9\x81$\x19\xf1H\x1a\r\xba\xdf\xe8\xb1|\\U\x86!\xd6\x1c\xa4u\xdd*j\x14f\x98\x89\x17\xf7^\xe9W\xcd j5\xe8\xb7\xa6<\x9a\x07>i\xd0Z\xd7\x00s;\xa8|r\xb1\xf07)\xf1\x02sl:\x157\x0fH9\xce.\xb9\xd3\x7f\x86?_\xb2\x97Z\x98\x8b\x89\x1c\x8d\xfdS\x8c\xf1m*\xaa\x9e1\x81\xa0\x16\x89\x00\x02\x8a\xb7\xbdo1\xee\x11c\xbd{]QU=\xa5\xc4:\x9e\x1d\xcfa\xca\xeb\\".\xcc\xb8\xfe\x08Mj\xc0U.x2Ng\x13~z\xaf\xa05\x81\xad\x01\xa0\x006\x16DP\xaa.\xd8;\xf9-\x1b\x17_\xac\x03\n?d\xa9\x0f\x13\xa2\xe0\x08\xe9:\xa2.W\xef\x8fg\x1f\xd0\xff\x00{\xbaVR\x1f\x14\t\x16\xf7\xd5zr"\xea\xf1<7u\xac\x0f\x11\x1b"%Q\xa2\xea6\x18D\x91\xa9s\x89\xeb\xe2#\xe8\x88\xb9\xd5m\x997\xe6>\xaa\xc0\xa2-t\xfd\x12\xab\xf8\x8dW\x07\xb5\xa0\xc0!\xc4\xc5\xb4#\x7fU\x02\xbd\x16\x9a\x8d\x9b\xd8\x9b\x92\xeb\xc8\x1b\xf9\xe8\x88\xa7%\x8d\x0e\xc5=\x80\x86\xb8\x80\x0b@\x130\x0cH\x12\xb7`\xab9\xe1\x99\x89t\xdc\xcf\x97$E\xc6Z\xab\x07\xd9\xad\x8d\xc1\x95\xb0\xb0i\xd1\x11vF\xb0\xb5S`\x0f\xcc\x04\x13by\xf9\xa2\'\xb2\xa6\xb9\xbe w\xd1B\xe2\xb5\x9c(<\x83q\xa7\xba"r\xf4\xa4Dk@\x10\x06\x8b\x08\x8a1\xaf\xff\xd9'
    with open('storage/assets/img/noCover.jpeg', 'wb') as f:
        f.write(img)
        f.close()

# 创建flask对象
app = fl(__name__, static_folder='storage', static_url_path='')

# 初始化全局变量
url = "http://127.0.0.1:8080/reader3/"
br = '<div class="wb"></div>'


@app.route("/")
def index():
    global url
    main_page = res.get(url + "getBookshelf").json()
    for book_info_ in main_page['data']:
        book_info_["coverUrl"] = book_info_[
            "coverUrl"] if "coverUrl" in book_info_ else '/assets/img/noCover.jpeg'
    return temp("bookshelf.html", main_page=main_page)


@app.route('/book/<path:p>')
def book_info(p):
    global url, br

    b_url = get_book_url("/book/")

    # 获取book shelf
    shelf = res.get(url + "getBookshelf").json()

    book_info_ = {}
    for i in shelf['data']:
        if i["bookUrl"] in b_url:
            book_info_ = i

    continue_read_link = f'/read/0/{book_info_["durChapterIndex"]}/{b_url}'

    if "durChapterTitle" not in book_info_.keys():
        last_read = "从未读过"
    else:
        last_read = book_info_["durChapterTitle"]

    cover = book_info_["coverUrl"] if "coverUrl" in book_info_ else '/assets/img/noCover.jpeg'
    intro = book_info_["intro"] if 'intro' in book_info_ else '这本书没有介绍哦'
    return temp("bookinfo.html",
                br=br, cover=cover,
                name=book_info_["name"],
                author=book_info_["author"],
                intro=str(intro).replace("\n", br),
                lastread=last_read,
                latestread=book_info_["latestChapterTitle"],
                continue_read_link=continue_read_link, book_url=b_url)


@app.route("/read/<save>/<index_>/<path:p>")
def book_read(index_, save, p):
    global url, br

    # 拼接url
    # index和外部函数重名的,容易出bug,改成index_了
    b_url = get_book_url(f"/read/{save}/{index_}/")

    # 创建请求数据
    get_content_json = {
        "url": b_url,
        "index": int(index_),
        "cache": 0
    }
    get_list_json = {
        "url": b_url,
        "refresh": 0
    }

    # 发送请求
    text = dict(res.post(url + "getBookContent", json=get_content_json).json())
    if "epub" in text["data"]:
        text = str(text["data"]).replace("/book-assets/", "")
        path1 = text
        with open(f"storage/data/{text}", 'r', encoding="UTF-8") as f:
            text1 = f.read()
            f.close()
        # 去除累赘
        path2 = path1.split('/')
        # 替换绝对路径
        path1 = path1.replace(f"/{path2[-1]}", "").replace(f"/{path2[-2]}", "").replace(f"/{path2[-2]}", "")
        text = text1.replace("..", f"/data/{path1}")
    else:
        text = "　　" + text["data"].replace("\n", br)
    chapter = res.post(url + "getChapterList", json=get_list_json).json()["data"]

    # 获取标题
    chapter_name = chapter[int(index_)]["title"]

    if int(save) == 1:
        save_book_json = {
            "url": url,
            "index": index_
        }
        res.post(url + "saveBookProgress", json=save_book_json)

    # 按钮
    # 判断上一章是否存在
    if index_ != '0':
        last_chapter = f'/read/1/{int(index_) - 1}/{b_url}'
        last_chapter = f'href="{last_chapter}"'
    else:
        last_chapter = 'onclick="alert(\'没有上一章啦\');"'

    # 判断下一章是否存在
    if index_ != str(len(chapter) - 1):
        next_chapter = f'/read/1/{int(index_) + 1}/{b_url}'
        next_chapter = f'href="{next_chapter}"'
    else:
        next_chapter = 'onclick="alert(\'没有下一章啦\');"'

    return temp("readbook.html", chaptername=chapter_name,
                br=br, text=text,
                next_zhang=next_chapter, last_zhang=last_chapter, bookurl=b_url)


@app.route("/chapter/<page>/<path:p>")
def book_chapter(page, p):
    # 初始化参数
    global book_info_, next_page
    page_int = int(page)
    b_url = get_book_url(f"/chapter/{page}/")
    # 取书架
    shelf = res.get(url + "getBookshelf").json()["data"]
    for i in shelf:
        if i["bookUrl"] == b_url:
            book_info_ = i

    # 取章节列表
    get_list_json = {
        "url": b_url,
        "refresh": 1
    }
    chapter = res.post(url + "getChapterList", json=get_list_json).json()["data"]

    read_chapter = []
    for i in range((page_int - 1) * 20, (page_int - 1) * 20 + 20):
        if i >= len(chapter):
            break
        read_chapter.append(chapter[i])

    if page == '1':
        last_page = 'onclick="alert(\'没有上一章啦\');"'
    else:
        last_page = f'/chapter/{page_int - 1}/{b_url}'
        last_page = f'href="{last_page}"'

    if (page_int * 20) >= len(chapter):
        next_page = 'onclick="alert(\'没有下一章啦\');"'
    elif page_int < len(chapter):
        next_page = f'/chapter/{page_int + 1}/{b_url}'
        next_page = f'href="{next_page}"'

    link = f'/book/{b_url}'
    return temp("chapter.html", name=book_info_["name"], page=page, chapter=read_chapter, book_url=b_url,
                lastpage=last_page, nextpage=next_page, link=link)


if __name__ == "__main__":
    try:
        if sys.argv[1] == "debug":
            app.run(host='0.0.0.0', debug=True)
        else:
            thread_starter()
    except:
        thread_starter()
    while True:
        try:
            t.join(timeout=0.1)
        except KeyboardInterrupt:
            sys.exit()
